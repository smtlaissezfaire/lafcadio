<html>
	<head>
		<title>Lafcadio</title>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<link rel="stylesheet" type="text/css" href="/style.css">
	</head>
	<body>
<h1><a href="/">Lafcadio</a></h1>
<h2>Tutorial</h2>

<h3>1. Download and install</h3>
<p>Lafcadio requires the following libraries:
<ul>
	<li><a href="http://log4r.sourceforge.net/">log4r</a></li>
	<li><a href="http://ruby-dbi.sourceforge.net/">Ruby DBI</a></li>
	<li>
		<a href="http://www.germane-software.com/software/rexml/">REXML</a>, which you already have if you're using Ruby 1.8 or later.
	</li>
	<li><a href="http://extensions.rubyforge.org/">Extensions</a></li>
</ul>
<p>
	The easiest way to install this is by using <a href="http://rubygems.rubyforge.org">Rubygems</a>. Simply type:
	<blockquote><tt>gem --remote-install lafcadio</tt></blockquote>
</p>

<h3>2. Create a configuration file</h3>
<p>In Lafcadio, the MySQL database is abstracted behind an object called an object store. To make that database connection in the first place, Lafcadio relies on a configuration file to tell it the password, username, etc. For the purposes of this tutorial, let's say your application uses a MySQL database named <tt>lafcadio_test</tt>, logging into a local MySQL server with a username <tt>user</tt> and password <tt>password</tt>.

<ol>
<li>Create a file named <tt>config.rb</tt> that sets the configuration:
<pre>require 'lafcadio'

LafcadioConfig.set_values(
  'dbuser' => 'user',
  'dbpassword' => 'password',
  'dbname' => 'lafcadio_test',
  'dbhost' => 'localhost'
)
</pre>
<p>Every script in your project needs to include this file.
</li>

<li>If you want to test that you've done it right, you can create a <tt>test.rb</tt> that tries to create the object store:
<pre>#!/usr/bin/env ruby

require 'config'
require 'lafcadio'
objectStore = ObjectStore.get_object_store
puts "Test succeeded."</pre>
<p>The database connection is made the first time you retrieve the objectStore, so if you've made any mistakes in the config file you'll get an error when you run this script. Otherwise it will tell you it succeeded.</li>
</ol>

<h3>3. Create a table, and corresponding object type</h3>
<p>Object types that are represented in the database are called domain objects. You need to write a class definition for each different domain object type.
<ol>
<li>First, so we have a domain object type, let's create a User type. Log into MySQL and create a users table:
<pre>
create table users (
  pk_id       int not null auto_increment,
  primary key (pk_id),
  first_name  varchar(64),
  last_name   varchar(64),
  email       varchar(64) not null,
  password    varchar(64) not null,
  birthday    date
);
</pre>
<p>Note that the primary key is named <tt>pk_id</tt>. Lafcadio is fairly flexible about what your tables look like, but it requires each table to have a numeric primary key. It assumes that it's going to be named <tt>pk_id</tt>, and that can be changed, but it's a little less work to go with the default.
<p>Although we're creating a new table in this example, Lafcadio can also be integrated with pre-existing tables with only a little more work.
</p>

<li>Write a child of DomainObject which defines the fields. Let's put this in <tt>user.rb</tt>:
<pre>require 'lafcadio'

class User < Lafcadio::DomainObject
  text 'first_name'
  text 'last_name'
  text 'email'
  text 'password'
  date 'birthday'
end
</pre>

<p>You write one field directive for every field in the table, except for <tt>pk_id</tt>. For style reasons, Lafcadio expects the table name to be the plural (<tt>users</tt>) and expects the domain class type to be singular (<tt>User</tt>). You can override this assumption if you like.

<li>Add the domain file as one of the <tt>domainFiles</tt> in your <tt>config.rb</tt> file.
<pre>require 'lafcadio'

LafcadioConfig.set_values(
  'dbuser' => 'user',
  'dbpassword' => 'password',
  'dbname' => 'lafcadio_test',
  'dbhost' => 'localhost',
  'domainFiles' => [ 'user.rb' ]
)
</pre>

</ol>


<h3>4. Manipulate some user objects</h3>
<p>Now that we've defined a domain object class, we can write a script that makes use of this.
<ol>
<li>Create a new user and save it to the database:
<pre>#!/usr/bin/env ruby

require 'config'
require 'user'

ten_years_ago = Date.today - (365 * 10)
john = User.new(
  'first_name' => 'John', 'last_name' => 'Doe', 'email' => 'john.doe@email.com',
  'password' => 'my_password', 'birthday' => ten_years_ago
)
john.commit
</pre>
<p>To create a user, you instantiate it with a hash. Notice that for the <tt>birthday</tt> field you don't have to think about SQL date formats; Lafcadio takes care of that automatically for you.
<p>If you run this script you'll find that your <tt>users</tt> table will have one record in it with an pk_id 1; this is John Doe.

<li>Retrieve a user and change some values:
<pre>#!/usr/bin/env ruby

require 'config'
require 'lafcadio'

ten_years = 365 * 10
object_store = ObjectStore.get_object_store
# retrieve user #1
john = object_store.get_user( 1 )
john.birthday -= ten_years
john.email = 'john.doe@mail.email.com'
john.commit
</pre>
<p>A few important details:
<ul>
<li>The object store makes extensive use of dynamic method dispatch, allowing you to call a method like <tt>get_user</tt>.
<li>All the domain object properties can be accessed like any object's properties.
<li>When you committed the object last time, the object store inserted a row into the database. This time, it updates the pre-existing row instead.
</ul></p>

<li>Delete the user:
<pre>#!/usr/bin/env ruby

require 'config'
require 'lafcadio'

object_store = ObjectStore.get_object_store
# retrieve user #1
john = object_store.get_user( 1 )
john.delete = true
john.commit
</pre>
</ol>

<h3>5. Add some methods to User</h3>
<p>The <tt>User</tt> class includes facilities to be saved to the database, but it's also a normal Ruby class, too. Accordingly, you can add methods to it to give yourself functionality that might be a pain to get with a SQL statement.

<p>For example, some users will enter only their first name or only their last name, or no name at all. It'd be convenient to have a method that accounts for this, so:

<pre>
class User < Lafcadio::DomainObject
  ...
  def name
    ( [ first_name, last_name ].select { |a_name| !a_name.nil? } ).join( ' ' )
  end
end
</pre>

<h3>6. Link another domain object to User</h3>
<p>Since you're dealing with a relational database, you'll likely want to have different tables relating to one another. Lafcadio uses LinkFields to accomplish this. For example, let's say you want to have a simple email-like system where users can send one another messages.

<ol>
<li>First, create a Messages table in MySQL:
<pre>
create table messages (
  pk_id       int not null,
  primary key (pk_id),
  subject     varchar(64) not null,
  body        varchar(255) not null,
  author      int not null,
  recipient   int not null,
  date_sent   date not null 
);
</pre>
</li>

<li>Then define a Message class.
<pre>
require 'lafcadio'
require 'user'

class Message < Lafcadio::DomainObject
  text 'subject'
  text 'body'
  link 'author', { 'linked_type' => User }
  link 'recipient', { 'linked_type' => User }
  date 'date_sent'
end
</pre>
</li>
<p>As before, you leave out the "pk_id" field.</p>

<li>Attach Users to Messages.
<p>Now you can treat instances of Users as values of the fields "author" and "recipient". For example, this code will save all the appropriate values to MySQL:

<pre>
#!/usr/bin/env ruby 

require 'config'

object_store = ObjectStore.get_object_store
john = object_store.get_user( 1 )
five_years_ago = Date.today - ( 365 * 5 )
jane = User.new(
  'first_name' => 'Jane', 'last_name' => 'Doe', 'email' => 'jane.doe@email.com',
  'password' => 'jane_pass', 'birthday' => five_years_ago
)
jane.commit
message_body = "Hey, Jane,\n\nWanna go to the movies on Saturday?"
message = Message.new(
  'subject' => 'hey', 'body' => message_body, 'author' => john,
  'recipient' => jane, 'date_sent' => Date.today
)
message.commit
</pre>
<p>With this code Lafcadio will save all the appropriate id numbers in the right fields in MySQL.
</ol>
<hr>
<a href="http://rubyforge.org"><img src="/img/rubyforge_logo.png" width="272" height="59"></a>
	</body>
</html>