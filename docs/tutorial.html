<html>
	<head>
		<title>Lafcadio</title>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<link rel="stylesheet" type="text/css" href="/style.css">
	</head>
	<body>
<h1><a href="/">Lafcadio</a></h1>
<h2>Tutorial</h2>

<h3>1. Download and install</h3>
<p>Lafcadio requires <a href="http://www.tmtm.org/ja/ruby/mysql/README_en.html">Ruby/MySQL</a>. (Please note that Ruby/MySQL and MySQL/Ruby are not the same thing.)
<div class="beta_note"><img src="/img/beta-logo.png">
<br>Lafcadio 0.3.1 and later also requires <a href="http://www.germane-software.com/software/rexml/">REXML</a>, which you'll need to have installed if you're using a Ruby version that's earlier than 1.8.0.

<p>Lafcadio 0.3.3 and later requires <a href="http://ruby-dbi.sourceforge.net/">Ruby DBI</a> instead of Ruby/MySQL.</p>
</div>
<ol>

<li><a href="https://sourceforge.net/project/showfiles.php?group_id=83312">Download Lafcadio</a>.

<li>Type <tt>tar zxvf lafcadio-0-3-3.tar.gz</tt> to decompress the file.

<li>Type <tt>./bin/install.rb</tt> to install Lafcadio. (You need to be logged in as root.) This will copy the Ruby files into the right subdirectory in <tt>/usr/local/lib/ruby/site_ruby/</tt>. There are no binary files.
<div class="beta_note"><img src="/img/beta-logo.png">
<br>Starting with Lafcadio 0.3.0, you'll type <tt>./install.rb</tt> instead. In addition to copying Ruby files into the subdirectory, there are some scripts (<tt>lafcadio_schema</tt> was the first, added with 0.3.0) to be installed in <tt>/usr/local/bin/</tt>.
</div>

</ol>

<h3>2. Create a configuration file</h3>
<p>In Lafcadio, the MySQL database is abstracted behind an object called an object store. To make that database connection in the first place, Lafcadio relies on a configuration file to tell it the password, username, etc. For the purposes of this tutorial, let's say your application uses a MySQL database named <tt>lafcadio_test</tt>, logging into a local MySQL server with a username <tt>user</tt> and password <tt>password</tt>.

<ol>
<li>Create a file named <tt>config.dat</tt> that looks like:
<blockquote><tt>dbuser:user
<br>dbpassword:password
<br>dbname:lafcadio_test
<br>dbhost:localhost</tt></blockquote>
<p>There is no default location for this configuration file, since you may end up using Lafcadio for a number of different unrelated projects on the same server, and you'll need a different configuration file for each project.

<li>Create a file named <tt>config.rb</tt> that sets the configuration file location:
<blockquote><tt>require 'lafcadio/util/LafcadioConfig'
<br>
<br># Tell the LafcadioConfig class where to find its data file
<br>LafcadioConfig.setFilename "/home/francis/lafcadio_test_project/config.dat"</tt></blockquote>
<p>Every script in your project needs to include this file.

<li>If you want to test that you've done it right, you can create a <tt>test.rb</tt> that tries to create the object store:
<blockquote><tt>#!/usr/bin/env ruby
<br>
<br>require 'config'
<br>require 'lafcadio/objectStore/ObjectStore'
<br>
<br>objectStore = ObjectStore.getObjectStore
<br>puts "Test succeeded."</tt></blockquote>
<p>The database connection is made the first time you retrieve the objectStore, so if you've made any mistakes in the config file you'll get an error when you run this script. Otherwise it will tell you it succeeded.
</ol>

<h3>3. Create a table, and corresponding object type</h3>
<p>Object types that are represented in the database are called domain objects. You need to write a class definition for each different domain object type.
<ol>
<li>First, so we have a domain object type, let's create a User type. Log into MySQL and create a users table:
<blockquote><tt>
create table users (
<br>&nbsp;&nbsp;objId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int not null auto_increment,
<br>&nbsp;&nbsp;primary key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(objId),
<br>&nbsp;&nbsp;firstName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(64),
<br>&nbsp;&nbsp;lastName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(64),
<br>&nbsp;&nbsp;email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(64) not null,
<br>&nbsp;&nbsp;password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(64) not null,
<br>&nbsp;&nbsp;birthday&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date
<br>);
</tt></blockquote>
<p>Note that the primary key is named <tt>objId</tt>. Lafcadio is fairly flexible about what your tables look like, but it requires each table to have a numeric primary key. It assumes that it's going to be named <tt>objId</tt>, and that can be changed, but it's a little less work to go with the default.
<p>Although we're creating a new table in this example, Lafcadio can also be integrated with pre-existing tables with only a little more work.
</p>
<div class="beta_note">
<img src="/img/beta-logo.png">
<br>It is possible in Lafcadio 0.3.0 and later to reverse the order of steps taken in this section: Instead of creating the table and defining the domain class later, you can define the domain class first and then use that to generate a SQL statement. First, follow steps 2 through 4. Then type <tt>lafcadio_schema -c &lt;config_file&gt; &lt;domain_file&gt;</tt> to get a SQL statement that you can use to create the table in MySQL.
</div>

<li>Create a directory in your project directory called <tt>domain/</tt>. This will be where your domain object definitions go.

<li>Add this domain directory to your <tt>config.dat</tt> file:
<blockquote><tt>
...
<br>domainDirs:/home/francis/lafcadio_test_project/domain/
</tt></blockquote>

<li>Write a domain object definition in <tt>domain/</tt>. Call it <tt>User.rb</tt>.
<blockquote><tt>
require 'lafcadio/domain/DomainObject'
<br>require 'lafcadio/objectField/TextField'
<br>require 'lafcadio/objectField/DateField'
<br>
<br>class User < DomainObject
<br>&nbsp;&nbsp;def User.getClassFields
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields = []
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << TextField.new(self, 'firstName')
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << TextField.new(self, 'lastName')
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << TextField.new(self, 'email')
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << TextField.new(self, 'password')
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << DateField.new(self, 'birthday')
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields
<br>&nbsp;&nbsp;end
<br>end
</tt></blockquote>
<p>You define one instance of a field for every field in the table, with the exception of <tt>objId</tt>. Lafcadio uses this array of fields to figure out what to request from the database.
<p>For style reasons, Lafcadio expects the table name to be the plural (<tt>users</tt>) and expects the domain class type to be singular (<tt>User</tt>). You can override this assumption if you like.
<div class="beta_note">
<img src="/img/beta-logo.png">
<br>Starting with Lafcadio 0.3.1, you can save a few keystrokes by writing an XML file with field descriptions instead of overriding <tt>DomainObject#getClassFields</tt>. You'll need to save all your XML files in one directory (call it the <tt>classDefinitionDir</tt> in your config file), and then save them as the same name as the class. For example, our <tt>User.xml</tt> file would look like:
<blockquote><tt>
&lt;lafcadio_class_definition name="User"&gt;<br>
&nbsp;&nbsp;&lt;field name="firstName" class="TextField"/&gt;<br>
&nbsp;&nbsp;&lt;field name="lastName" class="TextField"/&gt;<br>
&nbsp;&nbsp;&lt;field name="email" class="TextField"/&gt;<br>
&nbsp;&nbsp;&lt;field name="password" class="TextField"/&gt;<br>
&nbsp;&nbsp;&lt;field name="birthday" class="DateField"/&gt;<br>
&lt;/lafcadio_class_definition&gt;
</tt></blockquote>
</div>
</ol>

<h3>4. Manipulate some user objects</h3>
<p>Now that we've defined a domain object class, we can write a script that makes use of this.
<ol>
<li>Create a new user and save it to the database:
<blockquote><tt>#!/usr/bin/env ruby
<br>
<br>require 'config'
<br>require 'lafcadio/objectStore/ObjectStore'
<br>require 'domain/User'
<br>
<br>tenYearsAgo = Date.today - (365 * 10)
<br>john = User.new ({ 'firstName' => 'John', 'lastName' => 'Doe',
<br>&nbsp;&nbsp;&nbsp;&nbsp;'email' => 'john.doe@email.com', 'password' => 'my_password',
<br>&nbsp;&nbsp;&nbsp;&nbsp;'birthday' => tenYearsAgo })
<br>objectStore = ObjectStore.getObjectStore
<br>objectStore.commit john
</tt></blockquote>
<p>To create a user, you instantiate it with a hash. Notice that for the <tt>birthday</tt> field you don't have to think about SQL date formats; Lafcadio takes care of that automatically for you.
<p>If you run this script you'll find that your <tt>users</tt> table will have one record in it with an objId 1; this is John Doe.

<li>Retrieve a user and change some values:
<blockquote><tt>#!/usr/bin/env ruby
<br>
<br>require 'config'
<br>require 'lafcadio/objectStore/ObjectStore'
<br>
<br>tenYears = 365 * 10
<br>objectStore = ObjectStore.getObjectStore
<br># retrieve user #1
<br>john = objectStore.getUser 1
<br>john.birthday = john.birthday - tenYears
<br>john.email = 'john.doe@mail.email.com'
<br>objectStore.commit john
</tt></blockquote>
<p>A few important details:
<ul>
<li>The object store makes extensive use of dynamic method dispatch, allowing you to call a method like <tt>getUser</tt>.
<li>All the domain object properties can be accessed like any object's properties.
<li>When you committed the object last time, the object store inserted a row into the database. This time, it updates the pre-existing row instead.
</ul></p>

<li>Delete the user:
<blockquote><tt>#!/usr/bin/env ruby
<br>
<br>require 'config'
<br>require 'lafcadio/objectStore/ObjectStore'
<br>
<br>objectStore = ObjectStore.getObjectStore
<br># retrieve user #1
<br>john = objectStore.getUser 1 
<br>john.delete = true
<br>objectStore.commit john
</tt></blockquote>
</ol>

<h3>5. Add some methods to User</h3>
<p>The <tt>User</tt> class includes facilities to be saved to the database, but it's also a normal Ruby class, too. Accordingly, you can add methods to it to give yourself functionality that might be a pain to get with a SQL statement.

<p>For example, some users will enter only their first name or only their last name, or no name at all. It'd be convenient to have a method that includes this, so:

<blockquote><tt>
class User < DomainObject
<br>&nbsp;&nbsp;...
<br>&nbsp;&nbsp;def name
<br>&nbsp;&nbsp;&nbsp;&nbsp;nonNilNames = []
<br>&nbsp;&nbsp;&nbsp;&nbsp;[ firstName, lastName ].each { |aName| nonNilNames << aName if aName }
<br>&nbsp;&nbsp;&nbsp;&nbsp;nonNilNames.join (' ')
<br>&nbsp;&nbsp;end
<br>end
</tt></blockquote>

<h3>6. Link another domain object to User</h3>
<p>Since you're dealing with a relational database, you'll likely want to have different tables relating to one another. Lafcadio uses LinkFields to accomplish this. For example, let's say you want to have a simple email-like system where users can send one another messages.

<ol>
<li>First, create a Messages table in MySQL:
<blockquote><tt>
create table messages (
<br>&nbsp;&nbsp;objId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int not null,
<br>&nbsp;&nbsp;primary key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(objId),
<br>&nbsp;&nbsp;subject&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(64) not null,
<br>&nbsp;&nbsp;body&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varchar(255) not null,
<br>&nbsp;&nbsp;author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int not null,
<br>&nbsp;&nbsp;recipient&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int not null,
<br>&nbsp;&nbsp;dateSent&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date not null 
<br>);
</tt></blockquote>

<li>Then define a Message class.
<blockquote><tt>
require 'lafcadio/domain/DomainObject'
<br>require 'lafcadio/objectField/TextField'
<br>require 'lafcadio/objectField/DateField'
<br>require 'lafcadio/objectField/LinkField'
<br>require 'domain/User'
<br>
<br>class Message < DomainObject
<br>&nbsp;&nbsp;def Message.classFields
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields = []
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << TextField.new( self, 'subject' )
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << TextField.new( self, 'body' )
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << LinkField.new( self, User, 'author' )
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << LinkField.new( self, User, 'recipient' )
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields << DateField.new( self, 'dateSent' )
<br>&nbsp;&nbsp;&nbsp;&nbsp;fields
<br>&nbsp;&nbsp;end
<br>end
</tt></blockquote>
<p>As before, you leave out the "objId" field.
<div class="beta_note"><img src="/img/beta-logo.png">
<br>If you're using 0.3.1 or later you can have a file <tt>Message.xml</tt> with the field definitions like this:
<blockquote><tt>
&lt;lafcadio_class_definition name="Message"&gt;<br>
&nbsp;&nbsp;&lt;field name="subject" class="TextField" /&gt;<br>
&nbsp;&nbsp;&lt;field name="body" class="TextField" /&gt;<br>
&nbsp;&nbsp;&lt;field name="author" class="LinkField" linkedType="User" /&gt;<br>
&nbsp;&nbsp;&lt;field name="recipient" class="LinkField" linkedType="User" /&gt;<br>
&nbsp;&nbsp;&lt;field name="dateSent" class="DateField" /&gt;<br>
&lt;/lafcadio_class_definition&gt;
</tt></blockquote>
</div>

<li>Attach Users to Messages.
<p>Now you can treat instances of Users as values of the fields "author" and "recipient". For example, this code will save all the appropriate values to MySQL:

<blockquote><tt>
#!/usr/bin/env ruby 
<br>
<br>require 'config' 
<br>require 'lafcadio/objectStore/ObjectStore' 
<br>require 'domain/User' 
<br>require 'domain/Message'
<br>
<br>objectStore = ObjectStore.getObjectStore
<br>john = objectStore.getUser( 1 )
<br>fiveYearsAgo = Date.today - (365 * 5)
<br>jane = User.new({ 'firstName' => 'Jane', 'lastName' => 'Doe',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'email' => 'jane.doe@email.com', 'password' => 'jane_pass',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'birthday' => fiveYearsAgo })
<br>jane.commit
<br>messageBody = "Hey, Jane,\n\nWanna go to the movies on Saturday?"
<br>message = Message.new({ 'subject' => 'hey', 'body' => messageBody,
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'author' => john, 'recipient' => jane,
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'dateSent' => Date.today })
<br>message.commit
</tt></blockquote>

<p>With this code Lafcadio will save all the appropriate id numbers in the right fields in MySQL.
</ol>
<hr>
<a href="http://rubyforge.org"><img src="/img/rubyforge_logo.png" width="272" height="59"></a>
	</body>
</html>